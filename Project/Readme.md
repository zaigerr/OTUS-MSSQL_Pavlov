Я работаю в типографии. 
Наша типография занимается изготовлением этикетки и упаковки.
Свой проект я разрабатывал для неё.

Итак
Проект базы данных WEB центр.

Цель проекта:
Создания базы для согласования  (измененения и утверждения) макетов перед печатью тиража.

Аннотация
На любом производстве перед запуском массового тиража продукции происходит долгий этап согласования и утверждения.
Работа типографии в этом плане ничем не отличается от других производств.

Чтобы представить для чего я решил реализовать свой проект, опишу традиционную схему согласования 
макетов перед печатью тиража:

1) Заказчик отправялет электроный макет, в основном через e-mail или облако
2) Типография присваивает этому макету свой артикул, подготавливает тех.задание дизайнеру  
3) Дизайнер обрабатывает полученный макет под возможности печатного оборудования типографии, задает требуемые технологические допуски
4) Отправляет переработанный макет заказчику на согласование. (e-mail)
5) Заказчик получает макет и например, вспоминает, что забыл сменить ТУ или желает добавить новый QR код. 
Пишется новое письмо (e-mail) с комментариями какие изменения требуется внести.
Повторяются пункты 2,3,4
6) В конце концов Заказчик согласовывает макет (типография получает e-mail макета с подписью и печатью).

А теперь представьте, что у заказчика ассортимент больше 1000 видов
И эта процедура с отправкой электронных писем туда обратно повторяется многократно.
Иногда возникает необходимость поднять историй изменений по продукту, кто и когда запросил изменения. 
было ли запрошенное выполнено и кем? (просмотривать переписку занятие трудоемкое.)


Чтобы минимизировать свои риски, типографии требуется структурировать весь процесс согласования, упростить отправку сообщений, 
обеспечить сохранность запрошенных изменений, то есть вести историю продукта.

Имеющиеся инструменты в наличии:
На предприятии установлен коммерческое ПО Esko Automation Enginee
В нем ведется база продуктов (База на MS-SQL), у каждого продукта есть свой уникальный номер (артикул),
 превью макета, бланк согласования с техническим описанием макета
Но в используемом ПО не ведется история продукта, отсутствует модуль согласования продуктов с клиентами

Свой проект я назвал Web центр, подчеркивая названием работу через web браузер
Я создал базу, которая будет работать в связке с имеющейся базой продуктов от ESKO.

Какие задачи я хочу решить:
1) Сохранять историю изменений по каждому продукту
2) Сохранять и нумеровать заявки от клиента (В одной заявке может быть несколько продуктов)
3) Вести согласование продуктов через web центр, в рамках сформированной заявки
4) Отображать статус продуктов (Утверждено, внесение изменений, не утверждено)
5) Обеспечить доступ клиенту к продуктам из базы для повторных заказов.

Существующая база ESKO назвается BSJobs, схема  admin
Мной будет создана база WebCentre, схема Application и Web

Так как мой проект тесно связан с базой BSJobs, в которой есть свои ограничения, то мне придетсся подстраиваться под них.
Я не могу править существующие таблицы (добавлять или удалять поля, менять их тип) - это сказывается на работоспособности 
купленного продукта
Но могу добавлять новые таблицы и некоторые индексы при необходимости.

Итак начнем. 
В целом за основу взята идея интернет магазина. Но есть и отличия.

--1. Создаем пользователей.
Логином выступает e-mail (поэтому проверяем валидность адреса)
В таблице храним хэш пароля

--2. Раздача прав доступа 
Через процедуру [Application.AccessApplicationUsers]
Запись по-шагово (id-пользователь -- id заказчик)

--3. Вывод списка продуктов доступных пользователю (по странично)

В отличие от стандартного интернет магазина типографские продукты содержат дополнительную служебную информацию:
Статус утверждения, Состояние выполнения. Эти Статус и Состояния могут меняться.
Статус утверждения целиком зависит от заказчика, ему разрешено его менять. утверждать или вносить изменения.
Состояние выполнения зависит от исполнителя. по этому полю клиент может отследить на каком этапе выполнения находится его продукт, 
имя исполнителя.
Смотрим через процедуру [Web.proc_GetFilteredProducts]

Так как процедура на входе имеет много параметров, которые в зависимости от условий поиска могут быть, как использованы, так и равны NULL,
с регулярной переодичностью процедура могла зависать и вместо выполнения в несколько милисекунд могла отрабатывать за минуты.
Предполагаю, что это именно пресловутый Parameter Sniffing :
При первом выполнении запроса SQL Server компилирует план для конкретных значений параметров. 
Если следующие запросы используют другие параметры (например, LIKE '%...'), план может стать неэффективным.
Для борьбы с этим:
1. создал индекс на [admin].[BSProduct] на поле [Cusid] , а также
2. Добавил OPTION (RECOMPILE) 
3. Использовал пагинацию при выводе (постранично)

--4. Создаю корзину из доступных продуктов
Процедура [Web.proc_AddToCart]

--5. Процедура просмотра активной корзины  [Web.proc_GetCartContents]

--6. На основе готовой корзины создаю заказ. [Web.proc_AddToRequest]
Можно было бы просто обойтись, как в любом интернет магазине одной корзиной, 
но так как в процессе работы могут меняться статусы и состояния продуктов, добавляться новые комментарии 
и таких заказов у одного клиента одномоментно может быть несколько. Было решено трансформировать корзину в постоянную величину - ЗАКАЗ
После успешного сознания заказа корзина удаляется.
Для заказов создано две таблицы: [Web.RequestHead] и [Web.RequestElements]
в таблице [Web.RequestHead] содержатся общие данные, id заказчика, id создателя. наименование заказа, дата
Таблица [Web.RequestElements] детализация заказа , id продуктов, количество, наименование
Это версионная таблица. Выбор данного типа таблицы был обусловлен 
1) возможностью аудита всей строки
2) откат на предыдущую версию
Но версионированна таблица не хранит в себе автора изменений. Поэтому для записи истории комментариев, изменения статуса была создана 
обычная таблица [Web.BSPartCommentsHistory]. В этой таблице авторство строки всегда сохраняется.
Любая запись в этой таблице добавляется новой строкой, отсутствие update строк позволяет свести к минимуму взаимоблокировки.

Запись происходит через процедуру
[Web.proc_AddCommentUpdateStatus]

После завершения работы с заказом, когда все пожелания и комментарии написаны требуется уведомить исполнителя о новом заказе.
Для этой цели мной была активирована служба DB.mail, а также поднят service broker для отправки e-mail

В процессе активации почтовой службы в service broker были созданны таблицы 
[Web.ErrorLogs] - название говорит само за себя
[Web.EmailTemplates] - шаблоны писем
и [Web.NotificationEvents] - история уведомлений по заказу
